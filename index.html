<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portfolio Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #111827; color: #f3f4f6; }
    .card { background: #1f2937; border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.5); }
    .muted { color: #d1d5db; }
    .chip { background: rgba(255,255,255,0.1); padding: 0.25rem 0.5rem; border-radius: 999px; font-size: 0.75rem; }
    .chart-img { max-width: 100%; height: auto; border-radius: 8px; }
    .border-card { border: 1px solid rgba(255,255,255,0.2); }
    .spinner { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .error-box { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 1rem; }
    .img-placeholder { background: rgba(255,255,255,0.05); min-height: 200px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
  </style>
</head>
<body class="p-6">
  <div class="max-w-6xl mx-auto">
    <header class="mb-6">
      <h1 class="text-2xl font-semibold">Portfolio Dashboard</h1>
      <p class="text-sm muted">BY AJTITAN</p>
    </header>

    <!-- Loading State -->
    <div id="loadingState" class="flex flex-col items-center justify-center py-20">
      <div class="spinner"></div>
      <p class="mt-4 text-sm muted">Loading portfolio data...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden error-box">
      <h3 class="font-semibold text-red-400">Failed to Load Portfolio</h3>
      <p class="mt-2 text-sm muted" id="errorMessage"></p>
      <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm">Retry</button>
    </div>

    <!-- Main Content -->
    <main id="mainContent" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left Column -->
      <section class="lg:col-span-1 space-y-4">
        <div class="card p-4">
          <h2 class="text-lg font-medium">Summary</h2>
          <p id="summaryText" class="mt-2 text-sm muted">No summary available</p>
          <div class="mt-4">
            <h3 class="text-sm font-medium">Allocation</h3>
            <div id="allocationList" class="mt-2 space-y-2 text-sm"></div>
            <div class="mt-3" id="allocationChartContainer"></div>
          </div>
        </div>

        <div class="card p-4">
          <h2 class="text-lg font-medium">Risk Analysis</h2>
          <div id="riskSummary" class="mt-2 text-sm muted">No risk analysis available</div>
          <div class="mt-3" id="riskChartContainer"></div>
        </div>

        <div class="card p-4">
          <h2 class="text-lg font-medium">Education Tips</h2>
          <ul id="educationTips" class="mt-2 text-sm list-disc list-inside muted">
            <li>No tips available</li>
          </ul>
        </div>
      </section>

      <!-- Middle Column -->
      <section class="lg:col-span-2 space-y-4">
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-medium">Stocks Selected</h2>
            <span id="equityChip" class="chip">Equity Sleeve</span>
          </div>
          <div id="stocksGrid" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <p class="text-sm muted col-span-2">No stocks selected</p>
          </div>
        </div>

        <div class="card p-4">
          <h2 class="text-lg font-medium">What-if Analysis</h2>
          <div id="whatIfText" class="mt-2 text-sm muted">No what-if analysis available</div>
          <div class="mt-3" id="whatIfChartContainer"></div>
        </div>

        <div class="card p-4">
          <h2 class="text-lg font-medium">Mutual Funds</h2>
          <div id="mfList" class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
            <p class="text-sm muted col-span-2">No mutual funds selected</p>
          </div>
        </div>

        <div class="card p-4">
          <h2 class="text-lg font-medium">Diversifiers</h2>
          <div id="diversifiersList" class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
            <p class="text-sm muted col-span-2">No diversifiers selected</p>
          </div>
        </div>
      </section>
    </main>

    <footer class="mt-6 text-sm muted text-center">
      <span id="footerYear"></span> . AJTITAN
    </footer>
  </div>

<script>
// Utility functions
function safeGet(obj, path, defaultValue = '') {
  return path.split('.').reduce((acc, part) => acc && acc[part], obj) || defaultValue;
}

function createImageElement(src, alt, fallbackText = 'Chart unavailable') {
  if (!src) {
    return `<div class="img-placeholder text-sm muted">${fallbackText}</div>`;
  }
  return `<img src="${src}" alt="${alt}" class="chart-img" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'img-placeholder text-sm muted\\'>${fallbackText}</div>';" />`;
}

function showError(message) {
  document.getElementById('loadingState').classList.add('hidden');
  document.getElementById('errorState').classList.remove('hidden');
  document.getElementById('errorMessage').textContent = message;
}

function showContent() {
  document.getElementById('loadingState').classList.add('hidden');
  document.getElementById('mainContent').classList.remove('hidden');
}

async function loadPortfolio() {
  const userId = new URLSearchParams(window.location.search).get('user') || 'default';
  const jsonUrl = `https://raw.githubusercontent.com/ashish-in-progress/portfolio-json/main/${userId}.json`;

  try {
    const res = await fetch(jsonUrl);
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const text = await res.text();
    console.log('Raw JSON (first 500 chars):', text.substring(0, 500));
    console.log('JSON around error position:', text.substring(8600, 8650));
    
    let data;
    try {
      data = JSON.parse(text);
    } catch (parseErr) {
      throw new Error(`JSON parsing failed: ${parseErr.message}. Check console for details.`);
    }
    
    if (!data || typeof data !== 'object') {
      throw new Error('Invalid data format');
    }
    
    renderPortfolio(data);
    showContent();
  } catch (err) {
    console.error('Error loading portfolio:', err);
    showError(`Could not load portfolio for user "${userId}". ${err.message}`);
  }
}

function renderPortfolio(data) {
  // Summary
  const summary = safeGet(data, 'summary', 'No summary available');
  document.getElementById('summaryText').textContent = summary;

  // Allocation
  const alloc = data.allocation || {};
  const equitySleeves = alloc.equity_sleeves || {};
  const diversifiers = alloc.diversifiers || {};
  
  document.getElementById('allocationList').innerHTML = `
    <div><strong>Stocks:</strong> ${equitySleeves.stocks || '0%'}</div>
    <div><strong>Mutual Funds:</strong> ${equitySleeves.mutual_funds || '0%'}</div>
    <div><strong>Crypto:</strong> ${diversifiers.crypto || '0%'}</div>
    <div><strong>Bond MF:</strong> ${diversifiers.bond_mutual_funds || '0%'}</div>
    <div><strong>Gold:</strong> ${diversifiers.gold || '0%'}</div>
  `;
  
  const allocChart = safeGet(data, 'chart_url_allocation');
  document.getElementById('allocationChartContainer').innerHTML = 
    createImageElement(allocChart, 'Allocation Chart');

  // Risk Analysis
  const riskAnalysis = data.risk_analysis || {};
  document.getElementById('riskSummary').textContent = 
    riskAnalysis.summary || 'No risk analysis available';
  
  const riskChart = safeGet(riskAnalysis, 'quickchart_url');
  document.getElementById('riskChartContainer').innerHTML = 
    createImageElement(riskChart, 'Risk Chart');

  // What-if Analysis
  const whatIf = data.what_if_analysis || {};
  if (whatIf.conservative_return || whatIf.moderate_return || whatIf.optimistic_return) {
    document.getElementById('whatIfText').innerHTML = `
      <div class="text-sm muted"><strong>Conservative:</strong> ${whatIf.conservative_return || 'N/A'}</div>
      <div class="text-sm muted"><strong>Moderate:</strong> ${whatIf.moderate_return || 'N/A'}</div>
      <div class="text-sm muted"><strong>Optimistic:</strong> ${whatIf.optimistic_return || 'N/A'}</div>
    `;
  }
  
  const whatIfChart = safeGet(whatIf, 'quickchart_url');
  document.getElementById('whatIfChartContainer').innerHTML = 
    createImageElement(whatIfChart, 'What-if Chart');

  // Education Tips
  const tipsEl = document.getElementById('educationTips');
  const tips = data.education_tips || {};
  const tipValues = Object.values(tips).filter(t => t);
  
  if (tipValues.length > 0) {
    tipsEl.innerHTML = '';
    tipValues.forEach(tip => {
      const li = document.createElement('li');
      li.textContent = tip;
      tipsEl.appendChild(li);
    });
  }

  // Stocks
  const stocksGrid = document.getElementById('stocksGrid');
  const stocks = data.stocks_selected || [];
  
  if (stocks.length > 0) {
    stocksGrid.innerHTML = '';
    stocks.forEach(s => {
      const card = document.createElement('div');
      card.className = 'p-4 card';
      
      const buyLink = s.buy_link ? 
        `<a href="${s.buy_link}" target="_blank" rel="noopener noreferrer" class="text-sm underline hover:text-blue-400">Buy</a>` : 
        '';
      
      const reason = safeGet(s, 'analysis_summary.reason_for_selection(2-3 lines)', 'No analysis available');
      
      card.innerHTML = `
        <div class="flex items-start justify-between">
          <div>
            <h3 class="text-md font-semibold">${s.stock || 'Unknown'}</h3>
            <div class="muted text-sm">Price: ${s.current_price || 'N/A'}</div>
            <div class="muted text-sm">PE: ${s.pe || 'N/A'} • PB: ${s.pb || 'N/A'}</div>
          </div>
          <div class="text-right">${buyLink}</div>
        </div>
        <p class="mt-2 text-sm muted">${reason}</p>
        <div class="mt-3">
          ${createImageElement(s.chart, `${s.stock} chart`, 'Chart not available')}
        </div>
        <div class="mt-3 text-sm muted grid grid-cols-2 gap-2">
          <div><strong>52w High:</strong> ${s.week_52_high || 'N/A'}</div>
          <div><strong>52w Low:</strong> ${s.week_52_low || 'N/A'}</div>
          <div><strong>Dividend:</strong> ${s.dividend_yield || 'N/A'}</div>
          <div><strong>Debt/Equity:</strong> ${s.total_debt_to_equity || 'N/A'}</div>
        </div>
      `;
      stocksGrid.appendChild(card);
    });
  }

  // Mutual Funds
  const mfList = document.getElementById('mfList');
  const mutualFunds = data.mutual_funds_selected || [];
  
  if (mutualFunds.length > 0) {
    mfList.innerHTML = '';
    mutualFunds.forEach(m => {
      const el = document.createElement('div');
      el.className = 'p-3 border-card rounded';
      el.innerHTML = `
        <div class="text-sm font-medium">${m.name || 'Unknown Fund'}</div>
        <div class="muted text-xs">${m.category || 'N/A'} • 3y: ${m['3_year_return'] || 'N/A'} • 5y: ${m['5_year_return'] || 'N/A'}</div>
        <div class="mt-2 text-sm muted">${m.reason_for_investment || 'No reason provided'}</div>
      `;
      mfList.appendChild(el);
    });
  }

  // Diversifiers
  const diversifiersEl = document.getElementById('diversifiersList');
  const cryptos = data.crypto_selected || [];
  let hasDiversifiers = false;

  if (cryptos.length > 0) {
    diversifiersEl.innerHTML = '';
    hasDiversifiers = true;
    
    cryptos.forEach(c => {
      const el = document.createElement('div');
      el.className = 'p-3 border-card rounded';
      const buyLink = c.buy_link ? 
        `<a href="${c.buy_link}" target="_blank" rel="noopener noreferrer" class="text-xs underline hover:text-blue-400">Buy</a>` : 
        '';
      
      el.innerHTML = `
        <div class="flex justify-between items-center">
          <div>
            <div class="text-sm font-medium">${c.name || 'Unknown'} (${(c.symbol || '').toUpperCase()})</div>
            <div class="muted text-xs">Price: ${typeof c.current_price === 'number' ? c.current_price.toLocaleString() : c.current_price || 'N/A'} USD</div>
          </div>
          ${buyLink}
        </div>
        <div class="mt-2 text-sm muted">ROI: ${c.roi || 'N/A'}</div>
      `;
      diversifiersEl.appendChild(el);
    });
  }

  // Gold
  if (diversifiers.gold && diversifiers.gold !== '0%') {
    if (!hasDiversifiers) diversifiersEl.innerHTML = '';
    hasDiversifiers = true;
    
    const goldEl = document.createElement('div');
    goldEl.className = 'p-3 border-card rounded';
    const goldSummary = safeGet(data, 'Gold.summary') || safeGet(data, 'gold.summary', 'Hedge against inflation');
    goldEl.innerHTML = `
      <div class="text-sm font-medium">Gold</div>
      <div class="muted text-xs">Allocation: ${diversifiers.gold}</div>
      <div class="muted text-xs mt-1">${goldSummary}</div>
    `;
    diversifiersEl.appendChild(goldEl);
  }

  // Bond Mutual Funds
  if (diversifiers.bond_mutual_funds && diversifiers.bond_mutual_funds !== '0%') {
    if (!hasDiversifiers) diversifiersEl.innerHTML = '';
    hasDiversifiers = true;
    
    const bondEl = document.createElement('div');
    bondEl.className = 'p-3 border-card rounded';
    const bondSummary = safeGet(data, 'bond_mutual_funds.summary', 'Stable income generation');
    bondEl.innerHTML = `
      <div class="text-sm font-medium">Bond Mutual Funds</div>
      <div class="muted text-xs">Allocation: ${diversifiers.bond_mutual_funds}</div>
      <div class="muted text-xs mt-1">${bondSummary}</div>
    `;
    diversifiersEl.appendChild(bondEl);
  }
}

// Set current year in footer
document.getElementById('footerYear').textContent = new Date().getFullYear();

// Load portfolio on page load
loadPortfolio();
</script>

</body>
</html>
